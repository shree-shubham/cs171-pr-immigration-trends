<!DOCTYPE html>
<meta charset="utf-8">
<head>

	<!--Libraries-->
	<script src="libs/d3/d3.min.js" charset="utf-8"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
	<script src="/libs/datamaps/datamaps.world.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>

	<!--add own vis classes-->
	<script src = "js/emigrantcountryvis.js"></script>

	<!--add own stylesheets-->
	<link rel="stylesheet" href="/css/style.css" type="text/css">

	<span class="hdrs">
		<h1>Immigration Trends</h1>
	</span>
	<br>

</head>
<body>
	
	<div id="legend">	
	    <b>Year:</b> 1960
	        <input class = "slider" type="range" name="points" min="1960" max="2000" step="10" value="1960" id="slider-time" oninput=";"> 2000
	    <br><br>
			<label><input class="direction" type="radio" value="outgoing" checked>Outgoing (Emigrants)</label>
		    <label><input class="direction" type="radio" value="incoming"> Incoming (Immigrants)</label>
	 	<br><br>
	  		<label><input class="both_button" type="radio" value="both" checked>Both Sexes</label>
		    <label><input class="female_button" type="radio" value="female">Females Only</label>
		    <label><input class="male_button" type="radio" value="male" >Males Only</label>
	</div>
	
	<div id="container"></div>
	<div id="emigrantCountryVis" style="display:none"></div>

	<script>
		var g_data, 
			g_year = 1970,
			g_direction = "outgoing",
			g_sex = "both";
		var code_lookup = {}, arcs = [];
		var map;

		var w = window,
			d = document,
			e = d.documentElement,
			g = d.getElementsByTagName('body')[0],
			x = w.innerWidth || e.clientWidth || g.clientWidth,
			y = w.innerHeight|| e.clientHeight|| g.clientHeight;

		function updateWindow(){
			x = w.innerWidth || e.clientWidth || g.clientWidth;
			y = w.innerHeight|| e.clientHeight|| g.clientHeight;

			d3.select('#container').style({ "width": x.toString()+"px", "height": y.toString()+"px"});
			// d3.select('#container').select('svg').attr("width", x).attr("height", y);
		}

		window.onresize = updateWindow;
		updateWindow();

		function newyear(){
			g_data.forEach(function(i){
				partners[i.country_id] = i.years[year-1995].top_partners.map(function(d){ return d.country_id }); // create partners lookup
			});
			rendermap();
		}

		function processData(error, data, latlongs) {
			g_data = [];
			var years = ["1960", "1970", "1980", "1990", "2000"];
			data.forEach(function(obj) {
				if(obj.Gender != "Total"){

					var lastIndex = g_data.length - 1; 

					if(lastIndex >= 0 && g_data[lastIndex].country == obj.Origin){
						var current = g_data[lastIndex];
						current.years.forEach(function(yearObj){

							var lastDest = yearObj.dests.length - 1;
							if (lastDest >= 0 && yearObj.dests[lastDest].country == obj.Destination) { // dest exists, add to country

								yearObj.dests[lastDest][obj.Gender] = parseInt(obj[yearObj.year]);

							} else { // dest doesn't exist
								
								var newDest = {country: obj.Destination};
								newDest[obj.Gender] = parseInt(obj[yearObj.year]);
								yearObj.dests.push(newDest);

							}
						})

					}else{
						var thisCountry = latlongs["data"].filter(function(x){
							return x[10] == obj.Origin;
						});


						if(thisCountry.length > 0){
							thisCountry = thisCountry[0];
						}

						var yearsArr = years.map(function(yr){
							return {
								year: yr,
								dests: []
							}
						})

						var newCountry = {
							country: obj.Origin,
							latitude: parseInt(thisCountry[12]),
							longitude: parseInt(thisCountry[13]),
							years: yearsArr
						}

						g_data.push(newCountry);
					}
				}
			})

		   	drawMap();
		   	rendermap();
	    }

		function dataLoad() {
			queue()
				.defer(d3.csv, "data/data_codes.csv")
				.defer(d3.json, "data/countries_latlong.json")
				.await(processData);
		}
		
		dataLoad();

		function id_lookup(name){
			var x = g_data.filter(function(m){
				return m.name == name;
			})

			if(x.length == 0) return -1;
			else return x[0].country_id;
		};

		function drawMap(){
			map = new Datamap({
		    	scope: 'world',
		    	projection: 'mercator',
		    	element: document.getElementById('container'),
		    	fills: {
		    		defaultFill: 'rgba(255,255,255,0.4)'
		    	},
		    	geographyConfig:{
		    		borderColor: '#000000',
		    	}
		   	});
		}

		function rendermap(){

		   	var countries = Datamap.prototype.worldTopo.objects.world.geometries;
			for (var i = 0, j = countries.length; i < j; i++) {
				code_lookup[countries[i].id] = countries[i].properties.name;
			}

			//make some changes to be compatible with our data set
			code_lookup['USA'] = "United States";
			code_lookup['TZA'] = "Tanzania";

		   	
		    listener();
		}


		function listener(){
			d3.select('.slider').on("click", function(){

			});

			// displays emigrantCountryVis div on country click
			var MyEventHandler = new Object();
			var emigrant_country_vis = new EmigrantCountryVis(d3.select("#emigrantCountryVis"), g_data, MyEventHandler);
			
			$(MyEventHandler).bind("selectionChanged", function(event, countrydata, countryname){
				emigrant_country_vis.onSelectionChange(countrydata, countryname);
			})
			
			d3.selectAll(".datamaps-subunit").on("click", function(c){
				var ctry = d3.select(this);
				var code = ctry.attr("class").split(' ')[1];
				var countrydata = g_data.filter(function(n){
					return n.country == code;
				});
				var countryname = code_lookup[code];
				
				$("#emigrantCountryVis").show();

				$(MyEventHandler).trigger("selectionChanged", [countrydata[0], countryname])
			});

			// removes emigrantCountryVis div if click outside of country
			$(document).mouseup(function(e){
				var emigrantCountryVisDiv = $("#emigrantCountryVis");
				if(!emigrantCountryVisDiv.is(e.target) && emigrantCountryVisDiv.has(e.target).length === 0) {
					emigrantCountryVisDiv.hide();
				}
			});

			// makes emigrantCountryVis draggable
			document.getElementById('emigrantCountryVis').addEventListener('mousedown', mouseDown, false);
			window.addEventListener('mouseup', mouseUp, false);			
			function mouseUp(){
			    window.removeEventListener('mousemove', divMove, true);
			}
			function mouseDown(e){
			  window.addEventListener('mousemove', divMove, true);
			}
			function divMove(e){
			    var div = document.getElementById('emigrantCountryVis');
			  	div.style.position = 'absolute';
			  	div.style.top = e.clientY + 'px';
			  	div.style.left = e.clientX + 'px';
			}

			d3.selectAll(".datamaps-subunit").on("mouseover", function(c){

		    	var ctry = d3.select(this);
		    	var code = ctry.attr("class").split(' ')[1];
		    	ctry.style("fill", "#FF358B");
		    
		    	var arcs = [];



		    	var orig = g_data.filter(function(n){
					return n.country == code;
				});

				if(orig.length > 0){
					orig = orig[0];
				
				// Sort function
		    	var destSortFunc = function(a, b){
		    		var compa = 0;
		    		if("Male" in a) compa += a.Male;
		    		if("Female" in a) compa += a.Female;
		    		var compb = 0;
		    		if("Male" in b) compb += b.Male;
		    		if("Female" in b) compb += b.Female;
		    		return d3.descending(compa, compb);
		    	}

		    	var sortedDests = orig.years[0].dests.sort(destSortFunc);

		    	sortedDests = sortedDests.slice(0,10);
		    	// console.log(sortedDests);

				sortedDests.forEach(function(destObj, prank){
					var dest = g_data.filter(function(n){
						return n.country == destObj.country;
					});

					if(dest.length > 0){
						dest = dest[0];

						d3.selectAll(".datamaps-subunit").each(function(s){
							var code = d3.select(this).attr("class").split(' ')[1];
							if(code == dest.country){
								var opac = 1.0 - prank/6;
								d3.select(this).style("fill", "rgba(1,176,240,"+opac+")");
							}
						});

						if(typeof(orig) !== "undefined" && typeof(dest) !== "undefined"){
							arcs.push({
								origin: {
									latitude: orig.latitude,
									longitude: orig.longitude
								},
								destination: {
									latitude: dest.latitude,
									longitude: dest.longitude
								}
							})
						}
					}
				})
			}
					
		    	map.arc(arcs, {
					strokeColor: '#AEEE00',
					strokeWidth: 1,
					arcSharpness: 1,
				});
		    }).on("mouseout", function(c){
		    	d3.selectAll(".datamaps-subunit")
		    		.style("fill", "rgba(255,255,255,0.5)");
		    	map.arc([], {
					strokeColor: '#AEEE00',
					strokeWidth: 1,
					arcSharpness: 1,
				});
		    });


			d3.selectAll("select")
				.each(function(d){
					if(d3.select(this).attr("name") == 'year'){
						d3.select(this).on("change", function(){
							year = d3.select(this).property("value");
							newyear();
						});
					}
				});
		}


	</script>
</body>
</html>
