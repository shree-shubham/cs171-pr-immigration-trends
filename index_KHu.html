<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
	<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
	<script src="/libs/datamaps/datamaps.world.min.js"></script>
	<script src="/libs/jquery/jquery-2.1.1.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>

	<h1>Immigration Trends Visualization</h1>

	<form>
    Year select: 1960
        <input class = "slider" type="range" name="points" min="1960" max="2000" step="10" value="1960" id="slider-time" oninput=";"> 2000
    </form>

	<form>
		<label><input class="outgoing_button" type="radio" value="outgoing" checked>Outgoing Migrants</label>
	    <label><input class="incoming_button" type="radio" value="incoming"> Incoming Migrants</label>
  	</form>

  	<form>
  		<label><input class="both_button" type="radio" value="both" checked>Both Genders</label>
	    <label><input class="female_button" type="radio" value="female"> Female Only</label>
	    <label><input class="male_button" type="radio" value="male" >Male Only</label>
  	</form>

  	<br>

  	
    <div id="legend"></div>
    <br>
	<div id="container"></div>
	

	<script>
		var g_data, year = 1960;
		var code_lookup = {}, arcs = [];
		var map;

		var legend_data = [];
		var columns = ["country", "countrycode", "Male", "Female", "Total"];

		function newyear(){
			g_data.forEach(function(i){
				partners[i.country_id] = i.years[year-1995].top_partners.map(function(d){ return d.country_id }); // create partners lookup
			});
			rendermap();
		}

		function processData(error, data, codelookups, latlongs) {

			// process migration data
			g_data = [];
			var years = ["1960", "1970", "1980", "1990", "2000"];
			data.forEach(function(obj) {
				if(obj.Gender != "Total"){
					var lastIndex = g_data.length - 1; 
					if(lastIndex >= 0 && g_data[lastIndex].country == obj.Origin){
						var current = g_data[lastIndex];
						current.years.forEach(function(yearObj){
							var lastDest = yearObj.dests.length - 1;
							if (lastDest >= 0 && yearObj.dests[lastDest].country == obj.Destination) { // dest exists, add to country
								yearObj.dests[lastDest][obj.Gender] = parseInt(obj[yearObj.year]);
							} else { // dest doesn't exist		
								var newDest = {country: obj.Destination};
								newDest[obj.Gender] = parseInt(obj[yearObj.year]);
								yearObj.dests.push(newDest);
							} 
						})
					}else{
						var thisCountry = latlongs["data"].filter(function(x){
							return x[10] == obj.Origin;
						});
						if(thisCountry.length > 0){
							thisCountry = thisCountry[0];
						}
						var yearsArr = years.map(function(yr){
							return {
								year: yr,
								dests: []
							}
						})
						var newCountry = {
							country: obj.Origin,
							latitude: parseInt(thisCountry[12]),
							longitude: parseInt(thisCountry[13]),
							years: yearsArr
						}
						g_data.push(newCountry);
					}
				}
			})
			map = new Datamap({
		    	scope: 'world',
		    	projection: 'mercator',
		    	element: document.getElementById('container'),
		    	fills: {
		    		defaultFill: 'rgba(0,0,0,0.2)'
		    	}
		   	});

			codelookups.forEach(function(obj){
				code_lookup[obj.countrycode] = obj.countryname;
			})
		   	rendermap();
	    }

		function dataLoad() {
			queue()
				.defer(d3.csv, "data/data_codes.csv")
				.defer(d3.csv, "data/codes_to_countries.csv")
				.defer(d3.csv, "data/countries_to_codes.csv")
				.defer(d3.json, "data/countries_latlong.json")
				.await(processData);
		}
		
		dataLoad();

		function id_lookup(name){
			var x = g_data.filter(function(m){
				return m.name == name;
			})

			if(x.length == 0) return -1;
			else return x[0].country_id;
		};

		function rendermap(){
		   	draw_legend("", legend_data);
		    listener();
		}

		function listener(){
			d3.selectAll(".datamaps-subunit").on("mouseover", function(c){
				legend_data = []; // reset legend_data to be empty

		    	var ctry = d3.select(this);
		    	var code = ctry.attr("class").split(' ')[1];
		    	ctry.style("fill", "rgba(0, 0, 0, 0.5)");
		    
		    	var arcs = [];

		    	var orig = g_data.filter(function(n){
					return n.country == code;
				});

				if(orig.length > 0){
					orig = orig[0];
				
			    	var destSortFunc = function(a, b){
			    		return d3.descending(a.Female + a.Male, b.Female, b.Male);
			    	}

			    	var sortedDests = orig.years[0].dests.sort(destSortFunc);
						
			    	sortedDests = sortedDests.slice(0,10);

					sortedDests.forEach(function(destObj, prank){

						var dest = g_data.filter(function(n){
							return n.country == destObj.country;
						});

						if(dest.length > 0){
							dest = dest[0];

							d3.selectAll(".datamaps-subunit").each(function(s){
								var code = d3.select(this).attr("class").split(' ')[1];
								if(code == dest.country){
									var opac = 1.0 - prank/10;
									d3.select(this).style("fill", "rgba(188,52,68,"+opac+")");
								}
							});

							if(typeof(orig) !== "undefined" && typeof(dest) !== "undefined"){
								arcs.push({
									origin: {
										latitude: orig.latitude,
										longitude: orig.longitude
									},
									destination: {
										latitude: dest.latitude,
										longitude: dest.longitude
									}
								})
							}
						}
						newDestObj = destObj;
						newDestObj.country = code_lookup[destObj.country];
						newDestObj.countrycode = destObj.country;
						newDestObj.Total = destObj.Male + destObj.Female;
						legend_data.push(newDestObj);
					})
					console.log(legend_data);
				}

			    map.arc(arcs, {
						strokeColor: '#000000',
						strokeWidth: 1,
						arcSharpness: 1,
					});

			    redraw_legend(orig.country, legend_data);

		    }).on("mouseout", function(c){
		    	d3.selectAll(".datamaps-subunit")
		    		.style("fill", "rgba(0,0,0,0.2)");
		    	map.arc([], {
					strokeColor: '#000000',
					strokeWidth: 1,
					arcSharpness: 1,
				});
		    });

			d3.selectAll("select")
				.each(function(d){
					if(d3.select(this).attr("name") == 'year'){
						d3.select(this).on("change", function(){
							year = d3.select(this).property("value");
							newyear();
						});
					}
				});
		}

		function draw_legend(country, rows){

			var table = d3.select("#legend").append("table"),
			thead = table.append("thead")
                         .attr("class", "thead");
            tbody = table.append("tbody");

            table.append("caption")
              .html("Top 10 Migrant Destinations for " + code_lookup[country]);

            thead.append("tr").selectAll("th")
              .data(columns)
              .enter()
                .append("th")
                .text(function(d) { return d; });

            var rows = tbody.selectAll("tr.row")
                .data(rows)
                .enter()
                .append("tr").attr("class", "row");

            var cells = rows.selectAll("td")
                  .data(function(row) {
                      return d3.range(columns.length).map(function(column, i) {
                          return row[columns[i]];
                      });
                  })
                  .enter()
                  .append("td")
                  .text(function(d, i) {
                          return d; }) 
		}

		function redraw_legend(country, newrows){
			d3.select('table').remove();
            draw_legend(country, newrows);
		}


	</script>


</body>
</html>
